<script>

const today = (new Date()).toLocaleDateString();
const dateInput = document.getElementById("lastPeriodDate");
const dueDateInput = document.getElementById("dueDate");
const cycleLength = document.getElementById('cycleLength');

initCalculator()

// Once the date changed
dateInput.addEventListener("change", handleDate);
cycleLength.addEventListener("change", handleDate);



function initCalculator ()
{
    
    const lastPeriod = new Date(dateInput.value);

    // Calculate estimated ovulation date (14 days after the last period)
    const ovulationDate = new Date(lastPeriod);
    ovulationDate.setDate(lastPeriod.getDate() + (cycleLength.value - 14));

    dueDateInput.value = ovulationDate.toLocaleDateString() 

    customDate(lastPeriod, dueDateInput)


    const dd = daysUntil(ovulationDate);
    const daysText = dd > 0 ? dd : 7;
    handleDateText()
}



function handleDateText()
{
    
    const lmpDate = new Date(dateInput.value);

    // Add 260 days (40 weeks) to estimate the due date
    const estimatedDueDate = new Date(dueDateInput.value);

    // Find the start of the birth week (previous Monday)
    const startOfBirthWeek = new Date(estimatedDueDate);
    startOfBirthWeek.setDate(estimatedDueDate.getDate() - estimatedDueDate.getDay() + 1); // Monday

    // Find the end of the birth week (Sunday)
    const endOfBirthWeek = new Date(startOfBirthWeek);
    endOfBirthWeek.setDate(startOfBirthWeek.getDate() + 6); // Sunday

    // Format the result for readability
    const options = { year: 'numeric', month: 'long', day: 'numeric' };
    const startWeekFormatted = startOfBirthWeek.toLocaleDateString(undefined, options);
    const endWeekFormatted = endOfBirthWeek.toLocaleDateString(undefined, options);
    
    // Display the results
    const resultsDiv = document.getElementById('results');

    resultsDiv.innerHTML = ` ${startWeekFormatted} - ${endWeekFormatted}`;

}


function customDate (start , end) {
    
    const lmpDate = new Date(start);

    // Add 260 days (40 weeks) to estimate the due date
    const estimatedDueDate = new Date(start);

    // Find the start of the birth week (previous Monday)
    const startOfBirthWeek = new Date(estimatedDueDate);
    startOfBirthWeek.setDate(estimatedDueDate.getDate() - estimatedDueDate.getDay() + 1); // Monday

    // Find the end of the birth week (Sunday)
    const endOfBirthWeek = new Date(startOfBirthWeek);
    endOfBirthWeek.setDate(startOfBirthWeek.getDate() + 6); // Sunday

    // Format the result for readability
    const options = { year: 'numeric', month: 'short', day: 'numeric' };
    const startWeekFormatted = startOfBirthWeek.toLocaleDateString(undefined, options);
    const endWeekFormatted = endOfBirthWeek.toLocaleDateString(undefined, options);
    
    
    var i = 0;
    const date = new Date(dateInput.value);
    const endDate = new Date(dateInput.value);
    while (i < 40 ) {
        i++;
        date.setDate(date.getDate() + 7)
        endDate.setDate(date.getDate() + 7)
        jQuery('#week-date-'+i).html(date.toLocaleDateString(undefined, options) +" "+ endDate.toLocaleDateString(undefined, options))
    }

    return {start: startWeekFormatted, end: endWeekFormatted}
}
 
function daysUntil(date) {
	let targetDate;
	if (typeof date === "string") {
		const [year, month, day] = date.split("-").map(Number);
		targetDate = new Date(year, month - 1, day);
	} else if (date instanceof Date) {
		targetDate = date;
	} else {
		throw new Error(
			"Invalid date format. Please provide a Date object or a string in YYYY-MM-DD format."
		);
	}
	const today = new Date();
	today.setHours(0, 0, 0, 0);
	const timeDiff = targetDate - today;
	const daysDiff = Math.ceil(timeDiff / (1000 * 60 * 60 * 24));
    	
    return daysDiff;
}

function handleDate() {
    localStorage.setItem("savedlastPeriodDate", dateInput.value);
    initCalculator()
    jQuery('#estimated-date').removeClass('hidden')
}

function weeksBetween(d1, d2) {
    return Math.round((d2 - d1) / (7 * 24 * 60 * 60 * 1000));
}









</script>